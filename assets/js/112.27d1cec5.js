(window.webpackJsonp=window.webpackJsonp||[]).push([[112],{433:function(s,a,t){"use strict";t.r(a);var e=t(3),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"延迟基线测量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#延迟基线测量"}},[s._v("#")]),s._v(" 延迟基线测量")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("redis-cli ---intrinsic-latency "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-h")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("参数 100 是测试将执行的秒数，时间越长越能发现延迟峰值，通常 100 秒足以发现延迟问题（服务端运行避免网络环境的影响）")]),s._v(" "),a("h2",{attrs:{id:"慢指令监控"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢指令监控"}},[s._v("#")]),s._v(" 慢指令监控")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("操作复杂度为 O"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("N"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" 即为慢指令\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("使用 Redis 慢日志功能查出慢命令")]),s._v(" "),a("li",[s._v("latency-monitor（延迟监控）工具")])]),s._v(" "),a("h3",{attrs:{id:"慢日志功能"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢日志功能"}},[s._v("#")]),s._v(" 慢日志功能")]),s._v(" "),a("p",[s._v("Redis 中的 slowlog 命令用来快速定位那些超出指定执行时间的慢命令，默认 10ms")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#配置慢日志的时间，以微秒为单位；即超过 6 ms 写入慢指令日志")]),s._v("\nredis-cli CONFIG SET slowlog-log-slower-than "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#获取最近2个慢查询命令")]),s._v("\nSLOWLOG get "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"延迟监控工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#延迟监控工具"}},[s._v("#")]),s._v(" 延迟监控工具")]),s._v(" "),a("p",[s._v("Redis 在 2.8.13 版本引入了 "),a("a",{attrs:{href:"https://redis.io/topics/latency-monitor",target:"_blank",rel:"noopener noreferrer"}},[s._v("Latency Monitoring"),a("OutboundLink")],1),s._v(" 功能，用于以秒为粒度监控各种事件的发生频率")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设置延迟阈值，单位 ms")]),s._v("\nCONFIG SET latency-monitor-threshold "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("\ndebug "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nlatency latest\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"command"')]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1645330616")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2003")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2003")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#事件名称")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#事件发生的最近延迟 Unix 时间戳")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#延迟时间，单位毫秒")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#该事件的最大延迟")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h2",{attrs:{id:"优化方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优化方案"}},[s._v("#")]),s._v(" 优化方案")]),s._v(" "),a("h3",{attrs:{id:"网络通信导致的延迟"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络通信导致的延迟"}},[s._v("#")]),s._v(" 网络通信导致的延迟")]),s._v(" "),a("h3",{attrs:{id:"慢指令导致的延迟"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢指令导致的延迟"}},[s._v("#")]),s._v(" 慢指令导致的延迟")]),s._v(" "),a("h3",{attrs:{id:"fork-生成-rdb-导致的延迟"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fork-生成-rdb-导致的延迟"}},[s._v("#")]),s._v(" Fork 生成 RDB 导致的延迟")]),s._v(" "),a("h4",{attrs:{id:"禁用-linux-内存大页-transparent-huge-pages"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#禁用-linux-内存大页-transparent-huge-pages"}},[s._v("#")]),s._v(" 禁用 Linux 内存大页（transparent huge pages）")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" never "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/kernel/mm/transparent_hugepage/enabled\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"swap-操作系统分页"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#swap-操作系统分页"}},[s._v("#")]),s._v(" swap：操作系统分页")]),s._v(" "),a("h3",{attrs:{id:"aof-和磁盘-i-o-导致的延迟"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#aof-和磁盘-i-o-导致的延迟"}},[s._v("#")]),s._v(" AOF 和磁盘 I/O 导致的延迟")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("redis-cli CONFIG SET appendfsync no\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#no：Redis 不执行 fsync，唯一的延迟来自于 write 调用")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#everysec：Redis 每秒执行一次 fsync")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#always：每次写入操作都会执行 fsync")]),s._v("\n把配置项 no-appendfsync-on-rewrite设置为 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h2",{attrs:{id:"redis-性能变慢"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-性能变慢"}},[s._v("#")]),s._v(" Redis 性能变慢")]),s._v(" "),a("p",[s._v("获取当前 Redis 的基线性能；")]),s._v(" "),a("ul",[a("li",[s._v("开启慢指令监控，定位慢指令导致的问题")]),s._v(" "),a("li",[s._v("找到慢指令，使用 scan 的方式")]),s._v(" "),a("li",[s._v("将实例的数据大小控制在 2-4GB，避免主从复制加载过大 RDB 文件而阻塞")]),s._v(" "),a("li",[s._v("禁用内存大页，采用了内存大页，生成 RDB 期间，即使客户端修改的数据只有 50B 的数据，Redis 需要复制 2MB 的大页。当写的指令比较多的时候就会导致大量的拷贝，导致性能变慢")]),s._v(" "),a("li",[s._v("Redis 使用的内存是否过大导致使用 swap")]),s._v(" "),a("li",[s._v("AOF 配置是否合理，可以将配置项 no-appendfsync-on-rewrite 设置为 yes，避免 AOF 重写和 fsync 竞争磁盘 IO 资源，导致 Redis 延迟增加")]),s._v(" "),a("li",[s._v("bigkey 会带来一系列问题，我们需要进行拆分防止出现 bigkey，并通过 UNLINK 异步删除")])])])}),[],!1,null,null,null);a.default=n.exports}}]);