(window.webpackJsonp=window.webpackJsonp||[]).push([[122],{435:function(s,a,t){"use strict";t.r(a);var e=t(3),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("MySQL 的复制默认的异步的，主从复制至少需要两个 MySQL 服务，这些服务可以分布在不同服务器上，也可以在同一个台服务器上。")]),s._v(" "),a("h2",{attrs:{id:"一、主从复制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、主从复制"}},[s._v("#")]),s._v(" 一、主从复制")]),s._v(" "),a("h3",{attrs:{id:"_1-实现原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-实现原理"}},[s._v("#")]),s._v(" 1.实现原理")]),s._v(" "),a("p",[s._v("binlog 是 MySQL  的逻辑日志，用于记录数据库执行的写入性操作（不含查询）语句，以二进制的形式保存在磁盘中，使用任何存储引擎的 MySQL 都会记录。\nbinlog 通过追加的方式进行写入，设置 max_binlog_size 参数配置 binlog 文件的大小。\nMaster 开启 binlog，将 binlog 发送到各个 Slave，Slave 按 binlog 记录的语句重写，达到主从数据一致")]),s._v(" "),a("h3",{attrs:{id:"_2-优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-优化"}},[s._v("#")]),s._v(" 2.优化")]),s._v(" "),a("p",[s._v("MySQL 通过 sync_binlog 参数控制 biglog 的写入时机，取值范围是 0-N：")]),s._v(" "),a("ul",[a("li",[s._v("0：不强制要求，由系统自行判断何时写入")]),s._v(" "),a("li",[s._v("1：每次 commit 的时候都要写入")]),s._v(" "),a("li",[s._v("N：每执行 N 个事务，才会写入")])]),s._v(" "),a("p",[s._v("sync_binlog 最安全的设置是 1，（MySQL 5.7.7 之后版本默认），能有效保证主从的一致性；不过对数据库磁盘性能消耗较大，设置大一些的值可以提升数据库性能；可以按实际情况牺牲一致性来获取更好的性能。")]),s._v(" "),a("h3",{attrs:{id:"_3-格式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-格式"}},[s._v("#")]),s._v(" 3.格式")]),s._v(" "),a("p",[s._v("binlog 日志有三种格式，分别为：STATMENT、ROW 和 MIXED")]),s._v(" "),a("blockquote",[a("p",[s._v("在 MySQL 5.7.7 之前，默认的格式是 STATEMENT，之后默认值是 ROW；通过 binlog-format 参数指定")])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("STATMENT\n基于 SQL 语句的复制（statement-based replication, SBR），每一条会修改数据的 SQL 语句会记录到 binlog 中")])]),s._v(" "),a("li",[a("p",[s._v("优点：不需要记录每一行的变化，减少了 binlog 日志量，节约了 I/O，从而提高了性能")])]),s._v(" "),a("li",[a("p",[s._v("缺点：在某些情况下会导致主从数据不一致，如执行 sysdate()、slepp() 等")])]),s._v(" "),a("li",[a("p",[s._v("ROW\n基于行的复制（row-based replication, RBR），不记录每条 SQL 语句的上下文信息，仅需记录哪条数据被修改")])]),s._v(" "),a("li",[a("p",[s._v("优点：不会出现某些特定情况下的存储过程或 function、trigger 的调用和触发无法被正确复制的问题")])]),s._v(" "),a("li",[a("p",[s._v("缺点：会产生大量的日志，尤其是 alter table 的时候会让日志暴涨")])]),s._v(" "),a("li",[a("p",[s._v("MIXED\n基于上述两种模式的混合复制（mixed-based replication, MBR），一般复制使用 STATEMENT，对于无法复制的操作使用 ROW 模式来保存")])])]),s._v(" "),a("h3",{attrs:{id:"_4-部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-部署"}},[s._v("#")]),s._v(" 4.部署")]),s._v(" "),a("p",[s._v("主库、从库需要安装相同的稳定版 MySQL\n"),a("a",{attrs:{href:"https://www.yuque.com/go/doc/45493561?view=doc_embed",target:"_blank",rel:"noopener noreferrer"}},[s._v("MySQL 数据库入门"),a("OutboundLink")],1),s._v("\n主库上设置一个复制专用账户，并授予"),a("code",[s._v("REPLICATION SLAVE")]),s._v("权限")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("GRANT REPLICATION SLAVE ON *.* TO "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rep'")]),s._v("@xxx.xxx.xxx.xxx IDENTIFIED BY "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'8$TXDBJ*fLULiZ'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("修改主库的配置文件"),a("code",[s._v("/etc/my.cnf")]),s._v("，开启 BINLOG，并设置 server-id 的值，重启 MySQL 服务生效。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("log-bin"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql-bin\nserver-id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("锁定主库的表，确保备份之前没有新的数据操作，避免造成数据不一致")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("FLUSH TABLES WITH READ LOCK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("同步主库已有数据到从库\n主库操作：\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、停止主库的数据更新操作\nflush tables with "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("read")]),s._v(" lock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、新开终端，生成主数据库的备份（导出数据库）\nmysqldump "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-uroot")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ptest123")]),s._v(" cmdb "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" cmdb.sql\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、将备份文件传到从库\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" cmdb.sql root@192.168.8.11:/root/\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("、主库解锁\nunlock tables"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n从库操作：\nslave stop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ncreate database cmdb default charset utf8"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmysql "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-uroot")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ptest123")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" cmdb.sql \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("查看主库运行状态，记下 File 和 Position 数值，后续有用")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("SHOW MASTER STATUS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("将主库数据完整备份到从库，直接复制数据文件夹是最方便的做法，具体情况具体对待\n"),a("a",{attrs:{href:"https://www.yuque.com/ryds/op/noo00g?view=doc_embed",target:"_blank",rel:"noopener noreferrer"}},[s._v("MySQL 数据备份恢复"),a("OutboundLink")],1),s._v("\n修改从库的配置文件"),a("code",[s._v("/etc/my.cnf")]),s._v("，设置 server-id 参数（"),a("strong",[s._v("唯一值，不能重复")]),s._v("）")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("server-id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("通过 --skip-slave-start 选项启动从库，暂时跳过复制操作以便后续配置")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("CHANGE MASTER TO\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_HOST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx.xxx.xxx.xxx'")]),s._v(",\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_PORT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v(",\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_USER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rep'")]),s._v(",\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'8$TXDBJ*fLULiZ'")]),s._v(",\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_LOG_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.xxxxxxxx'")]),s._v(",\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MASTER_LOG_POS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("xxx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("解开主库的锁")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("UNLOCK TABLES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在从库上开启复制进程并查看详情")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("start slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nshow processlist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("G"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"二、读写分离"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、读写分离"}},[s._v("#")]),s._v(" 二、读写分离")]),s._v(" "),a("p",[s._v("读写分离是主从复制的常规操作，即：主库处理"),a("strong",[s._v("增")]),s._v("（INSERT）、"),a("strong",[s._v("删")]),s._v("（DELETE）、"),a("strong",[s._v("改")]),s._v("（UPDATE）及"),a("strong",[s._v("事务性查询")]),s._v("（SELECT）操作，从库只处理"),a("strong",[s._v("非事务性查询")]),s._v("（SELECT）操作\n"),a("img",{attrs:{src:"https://f.pz.al/pzal/2023/01/13/884666871a1fc.jpg",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"三、数据一致"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、数据一致"}},[s._v("#")]),s._v(" 三、数据一致")]),s._v(" "),a("p",[s._v("主从复制的原理是将主库的语句通过读取"),a("code",[s._v("binlog")]),s._v("的方式在从库上执行，当服务高并发时，从库的数据更新会有延迟：刚写入主库的数据需要经过几十、几百毫秒、甚至更长才能在从库查询到。")]),s._v(" "),a("ul",[a("li",[s._v("网络方面： 保证主、从库之间的网络稳定，以及延迟较小")]),s._v(" "),a("li",[s._v("硬件方面： 从库使用更好的配置，提高随机读写的性能")]),s._v(" "),a("li",[s._v("并行复制： 从 MySQL 5.7 以后，新增了多线程复制技术，解决了主库同一个 schema 下数据发生变更，从库不能处理并发的问题。")])])])}),[],!1,null,null,null);a.default=n.exports}}]);